(function(){
  "use strict";
  if (typeof window.user === "undefined") return;

  document.documentElement.classList.add("wise-theme");

  injectCSS(`
.wise-theme .wise-proj-edit-dialog{
  border-radius: 12px;
  overflow: hidden;
}

.wise-theme .wise-proj-edit-dialog .ui-dialog-titlebar{
  background: #0B1B2B;
  border: none;
  color: #F6F2EA;
}

.wise-theme .wise-proj-edit-dialog .ui-dialog-content{
  border: none;
  background: #F6F2EA;
}

.wise-theme .wise-proj-edit-dialog input.data_cell,
.wise-theme .wise-proj-edit-dialog textarea.data_cell,
.wise-theme .wise-proj-edit-dialog select.data_cell{
  border-radius: 10px;
  border: 1px solid rgba(17,24,39,.18);
  padding: 6px 8px;
}
`);

  $(document).on("dialogopen", ".ui-dialog-content", function(){
    const $content = $(this);

    // Project edit popup instance
    if (!$content.is("#edit_dialog.custom_projEditFrame")) return;

    // Scope styling to this dialog (title bar sits outside #edit_dialog)
    const $wrapper = $content.closest(".ui-dialog");
    if (!$wrapper.hasClass("wise-proj-edit-dialog")) {
      $wrapper.addClass("wise-proj-edit-dialog");
    }

    // KILL: client contact rows
    hideRowByDataField($content, "TELEPHONE");
    hideRowByDataField($content, "MOBILE");
    hideRowByDataField($content, "EMAIL");
    hideRowContainingButtonText($content, "Add to address book");

    // KEEP: Deliver to + Delivery address, hide other address modes
    forceDeliveryOnlyKeepAddress($content);

    // KILL: Delivery phone number (hide the whole telephone row in the delivery section)
    hideDeliveryTelephoneRow($content);

    // Cosmetic: remove visible "n/a" labels
    blankNALabels($content);
  });

  // ---------------- helpers ----------------

  function hideRowByDataField($root, field){
    $root.find(`[data-field="${field}"]`).each(function(){
      const $tr = $(this).closest("tr");
      if ($tr.length) $tr.hide();
    });
  }

  function hideRowContainingButtonText($root, text){
    $root.find("button").each(function(){
      if ($(this).text().trim() === text){
        const $tr = $(this).closest("tr");
        if ($tr.length) $tr.hide();
      }
    });
  }

  function forceDeliveryOnlyKeepAddress($root){
    // Name line: keep DELIVER_TO only
    $root.find(".name_container input.delivery").show();
    $root.find(".name_container input.use_at, .name_container input.collection").hide();

    // Address block: KEEP delivery address
    $root.find(".address_container textarea.delivery").show();
    $root.find(".address_container textarea.use_at, .address_container textarea.collection").hide();

    // Hide mode switchers for use_at/collection; keep delivery
    $root.find(".label_container .label.use_at, .label_container .label.collection").hide();
    $root.find(".label_container .label.delivery").show();

    // Ensure selected state looks correct
    $root.find(".label_container .label").addClass("ui-state-disabled").removeClass("ui-state-selected");
    $root.find(".label_container .label.delivery").removeClass("ui-state-disabled").addClass("ui-state-selected");

    // Ensure the left-hand heading reads "Deliver to"
    $root.find(".delivery_label").text("Deliver to");
  }

  function hideDeliveryTelephoneRow($root){
    // In your HTML, all delivery/use_at/collection telephone inputs live in one <tr>.
    // Hiding the <tr> kills delivery phone without touching delivery address.
    const $deliveryPhone = $root.find(`[data-field="DELIVERY_TELEPHONE"]`).first();
    if ($deliveryPhone.length){
      const $tr = $deliveryPhone.closest("tr");
      if ($tr.length) $tr.hide();
    }
  }

  function blankNALabels($root){
    $root.find("td.label").each(function(){
      const t = $(this).text().trim().toLowerCase();
      if (t === "n/a") $(this).text("");
    });
  }

  function injectCSS(cssText){
    const id = "wise-proj-edit-css";
    if (document.getElementById(id)) return;
    const style = document.createElement("style");
    style.id = id;
    style.type = "text/css";
    style.appendChild(document.createTextNode(cssText));
    document.head.appendChild(style);
  }
})();
